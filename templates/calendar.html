{% extends "base.html" %}

{% block title %}{{ player_name }}'s Calendar{% endblock %}

{% block nav_items %}
<a href="{{ url_for('player_calendar', player_name=player_name) }}">ðŸ“… Calendar</a>
{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
    .player-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    .player-header h2 {
        color: white;
        margin: 0 0 10px 0;
        font-size: 2em;
    }
    .game-count-badge {
        background: rgba(255,255,255,0.2);
        padding: 8px 15px;
        border-radius: 20px;
        display: inline-block;
        font-size: 0.9em;
    }
    #calendar {
        margin-top: 20px;
    }
    @media (max-width: 768px) {
        .fc .fc-timegrid-slot {
            height: 3em;
        }
    }
    .fc-event.status-OPEN {
        background-color: #d4edda !important;
        border-color: #28a745 !important;
    }
    .fc-event.status-OPEN .fc-event-title {
        color: #155724;
    }
    .fc-event.status-FULL {
        background-color: #f8d7da !important;
        border-color: #dc3545 !important;
    }
    .fc-event.status-FULL .fc-event-title {
        color: #721c24;
    }
    .legend {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        font-size: 0.9em;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border: 1px solid #333;
        border-radius: 2px;
    }
    .actions {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
    }
    .btn {
        display: inline-block;
        padding: 12px 24px;
        background: #667eea;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-weight: 600;
        transition: background 0.2s;
    }
    .btn:hover {
        background: #5568d3;
    }
    @page {
        size: landscape;
        margin: 0.35in;
    }
    @media print {
        * {
            box-sizing: border-box;
        }
        html, body {
            width: 11in;
            height: 8.5in;
            margin: 0;
            padding: 0;
            background: white;
        }
        body {
            font-size: 10pt;
        }
        .container {
            width: 11in;
            height: 8.5in;
            margin: 0;
            padding: 0;
            box-shadow: none;
            border-radius: 0;
            display: flex;
            flex-direction: column;
        }
        header, nav, .actions, footer, .game-count-badge, .legend {
            display: none;
        }
        .player-header {
            background: none;
            color: black;
            padding: 0.25in 0.35in 4px 0.35in;
            margin: 0;
            border-bottom: 2px solid #000;
            flex-shrink: 0;
        }
        .player-header h2 {
            color: black;
            font-size: 14pt;
            margin: 0;
            font-weight: bold;
        }
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 0.35in 0.35in 0.35in;
        }
        #calendar {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            flex: 1;
        }
        /* FullCalendar print overrides */
        .fc {
            width: 100% !important;
            height: 100% !important;
            font-size: 7.5pt !important;
        }
        .fc-timegrid {
            border: 1px solid #999;
        }
        .fc .fc-col-header {
            background: #f5f5f5;
            padding: 2px 0;
            border: 1px solid #999;
            font-size: 8pt !important;
        }
        .fc .fc-daygrid-day,
        .fc .fc-timegrid-cell {
            border: 1px solid #ccc;
        }
        .fc-event {
            margin: 0 !important;
            padding: 0.5px !important;
            font-size: 6.5pt !important;
        }
        .fc-event-title {
            font-weight: 600;
            font-size: 6.5pt !important;
        }
        .fc .fc-button {
            display: none;
        }
        .fc .fc-toolbar {
            display: none;
        }
        .fc-view-harness {
            width: 100%;
            height: 100%;
        }
        .fc-daygrid,
        .fc-timegrid {
            width: 100%;
            height: 100%;
        }
        .fc-scroller {
            overflow: visible !important;
            height: auto !important;
        }
        .fc-timegrid-body {
            overflow: visible !important;
        }
        .fc-col-time {
            width: 50px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="player-header">
    <h2>{{ player_name }}'s Calendar</h2>
    <div class="game-count-badge">ðŸŽ® {{ games|length }} game{{ 's' if games|length != 1 else '' }} scheduled</div>
</div>

<div class="legend">
    <div class="legend-item">
        <div class="legend-color" style="background: #d4edda;"></div>
        <span>Open (has space)</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #f8d7da;"></div>
        <span>Full (no space)</span>
    </div>
</div>

<div id='calendar'></div>

<div class="actions">
    <a href="{{ url_for('player_schedule', player_name=player_name) }}" class="btn">ðŸ“‹ List View</a>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const games = {{ games|tojson }};

        // Date mapping (generated from server config)
        const dayMap = {
            'Thursday': '{{ get_convention_date("Thursday") }}',
            'Friday': '{{ get_convention_date("Friday") }}',
            'Saturday': '{{ get_convention_date("Saturday") }}',
            'Sunday': '{{ get_convention_date("Sunday") }}'
        };

        // Convert games to FullCalendar events
        const events = games.map(game => {
            // Parse dates and times
            const dayStr = game.start_day;
            const startTimeStr = game.start_time;
            const endTimeStr = game.end_time;

            const startDate = dayMap[dayStr];
            const endDate = dayMap[game.end_day] || startDate;

            return {
                title: game.name,
                start: `${startDate}T${startTimeStr}:00`,
                end: `${endDate}T${endTimeStr}:00`,
                classNames: [`status-${game.status || 'UNKNOWN'}`],
                extendedProps: {
                    table: game.table,
                    status: game.status,
                    playerCount: game.players.length,
                    players: game.players
                }
            };
        });

        // Set initial date to the convention start date
        const initialDate = dayMap['Thursday'];

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialDate: initialDate,
            initialView: 'timeGridFourDay',
            headerToolbar: {
                left: 'title',
                center: '',
                right: ''
            },
            views: {
                timeGridFourDay: {
                    type: 'timeGrid',
                    duration: { days: 4 },
                    buttonText: '4-Day View'
                }
            },
            businessHours: {
                daysOfWeek: [4, 5, 6, 0],
                startTime: '09:00',
                endTime: '24:00'
            },
            slotLabelInterval: '00:30',
            slotLabelFormat: {
                hour: 'numeric',
                minute: '2-digit',
                meridiem: 'short',
                omitZeroMinute: false
            },
            slotMinTime: '09:00',
            slotMaxTime: '24:00',
            events: events,
            eventContent: function(arg) {
                const props = arg.event.extendedProps;
                const startTime = arg.event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const endTime = arg.event.end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                // Build tooltip text with all game info
                let tooltipText = `${arg.event.title}\n${startTime} - ${endTime}`;
                if (props.table) tooltipText += `\nTable: ${props.table}`;
                tooltipText += `\nStatus: ${props.status || 'Unknown'}`;
                tooltipText += `\nPlayers: ${props.playerCount}`;

                // Display: Game title (large), then times, then table ID
                let html = `<div class="fc-event-main" title="${tooltipText}" style="color: black; font-weight: 600;">
                    <strong>${arg.event.title}</strong><br>
                    <small>${startTime} - ${endTime}</small>`;
                if (props.table) {
                    html += `<br><small>Table ${props.table}</small>`;
                }
                html += '</div>';

                return { html };
            }
        });

        calendar.render();
    });
</script>
{% endblock %}
